---
- name: Check if Nix is installed
  command: which nix
  register: nix_check
  ignore_errors: true
  changed_when: false
  tags: ["nix"]

- name: Install Nix package manager
  block:
    - name: Download and run Nix installer
      shell: |
        curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
      args:
        creates: /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  when: nix_check.rc != 0
  tags: ["nix", "packages"]

- name: Source Nix environment (temporary for this playbook)
  shell: |
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    echo "$PATH"
  register: nix_path
  changed_when: false
  when: nix_check.rc != 0
  tags: ["nix"]

- name: Install packages with Nix
  shell: |
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    nix profile install {{ nix_packages | join(' ') }}
  args:
    executable: /bin/bash
  register: nix_install
  changed_when: "'error' not in nix_install.stderr"
  when: nix_packages | length > 0
  tags: ["nix", "packages"]